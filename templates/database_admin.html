<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Admin - Trevnoctilla</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0a0a0a;
        color: #f5f5f5;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      h1 {
        color: #8b5cf6;
        margin-bottom: 30px;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #2a2a2a;
      }
      .tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #a0a0a0;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s;
      }
      .tab.active {
        color: #8b5cf6;
        border-bottom-color: #8b5cf6;
      }
      .tab:hover {
        color: #ffffff;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #111111;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
      }
      th {
        background: #1a1a1a;
        color: #8b5cf6;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #2a2a2a;
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #2a2a2a;
      }
      tr:hover {
        background: #1a1a1a;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }
      .btn-danger {
        background: #dc2626;
        color: white;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }
      .btn-primary {
        background: #8b5cf6;
        color: white;
      }
      .btn-primary:hover {
        background: #7c3aed;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: #111111;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #2a2a2a;
      }
      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #8b5cf6;
      }
      .stat-label {
        color: #a0a0a0;
        margin-top: 8px;
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .search-box {
        padding: 10px;
        background: #111111;
        border: 1px solid #2a2a2a;
        border-radius: 6px;
        color: #f5f5f5;
        width: 300px;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge-success {
        background: #10b981;
        color: white;
      }
      .badge-danger {
        background: #dc2626;
        color: white;
      }
      .badge-info {
        background: #3b82f6;
        color: white;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #a0a0a0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üóÑÔ∏è Database Admin Panel</h1>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="users-count">-</div>
          <div class="stat-label">Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="api-keys-count">-</div>
          <div class="stat-label">API Keys</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="usage-logs-count">-</div>
          <div class="stat-label">Usage Logs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="notifications-count">-</div>
          <div class="stat-label">Notifications</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('users')">Users</button>
        <button class="tab" onclick="showTab('api-keys')">API Keys</button>
        <button class="tab" onclick="showTab('usage-logs')">Usage Logs</button>
        <button class="tab" onclick="showTab('notifications')">
          Notifications
        </button>
      </div>

      <div class="actions">
        <input
          type="text"
          class="search-box"
          id="search"
          placeholder="Search..."
          onkeyup="filterTable()"
        />
        <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh</button>
      </div>

      <div id="users" class="tab-content active">
        <table id="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Tier</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr>
              <td colspan="7" class="loading">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="api-keys" class="tab-content">
        <table id="api-keys-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>User ID</th>
              <th>Key (Preview)</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="api-keys-tbody">
            <tr>
              <td colspan="5" class="loading">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="usage-logs" class="tab-content">
        <table id="usage-logs-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>User ID</th>
              <th>Endpoint</th>
              <th>Method</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="usage-logs-tbody">
            <tr>
              <td colspan="6" class="loading">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="notifications" class="tab-content">
        <table id="notifications-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Type</th>
              <th>Read</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="notifications-tbody">
            <tr>
              <td colspan="6" class="loading">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;

      function showTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");
        document.getElementById(tabName).classList.add("active");
        loadData();
      }

      async function loadData() {
        try {
          const response = await fetch(`${API_BASE}/test/view-database`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.error || data.message || `HTTP ${response.status}`
            );
          }

          // Check if data has the expected structure
          if (!data || !data.counts) {
            throw new Error("Invalid response format from server");
          }

          // Update stats
          document.getElementById("users-count").textContent =
            data.counts.users || 0;
          document.getElementById("api-keys-count").textContent =
            data.counts.api_keys || 0;
          document.getElementById("usage-logs-count").textContent =
            data.counts.usage_logs || 0;
          document.getElementById("notifications-count").textContent =
            data.counts.notifications || 0;

          // Render users
          renderUsers(data.users || []);
          renderApiKeys(data.api_keys || []);
          renderUsageLogs(data.usage_logs || []);
          renderNotifications(data.notifications || []);
        } catch (error) {
          console.error("Error loading data:", error);
          const errorMessage = error.message || "Failed to load database data";
          alert(`Failed to load database data: ${errorMessage}`);

          // Show error in UI
          document.getElementById(
            "users-tbody"
          ).innerHTML = `<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error: ${errorMessage}</td></tr>`;
          document.getElementById(
            "api-keys-tbody"
          ).innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc2626;">Error: ${errorMessage}</td></tr>`;
          document.getElementById(
            "usage-logs-tbody"
          ).innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc2626;">Error: ${errorMessage}</td></tr>`;
          document.getElementById(
            "notifications-tbody"
          ).innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc2626;">Error: ${errorMessage}</td></tr>`;
        }
      }

      function renderUsers(users) {
        const tbody = document.getElementById("users-tbody");
        if (users.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; color: #a0a0a0;">No users found</td></tr>';
          return;
        }
        tbody.innerHTML = users
          .map(
            (user) => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-info">${user.role}</span></td>
                    <td><span class="badge ${
                      user.is_active ? "badge-success" : "badge-danger"
                    }">${user.is_active ? "Active" : "Inactive"}</span></td>
                    <td><span class="badge badge-info">${
                      user.subscription_tier
                    }</span></td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteUser('${
                          user.email
                        }')">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function renderApiKeys(keys) {
        const tbody = document.getElementById("api-keys-tbody");
        if (keys.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #a0a0a0;">No API keys found</td></tr>';
          return;
        }
        tbody.innerHTML = keys
          .map(
            (key) => `
                <tr>
                    <td>${key.id}</td>
                    <td>${key.user_id}</td>
                    <td><code>${key.key_prefix || "N/A"}</code></td>
                    <td>${new Date(key.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteApiKey(${
                          key.id
                        })">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function renderUsageLogs(logs) {
        const tbody = document.getElementById("usage-logs-tbody");
        if (logs.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #a0a0a0;">No usage logs found</td></tr>';
          return;
        }
        tbody.innerHTML = logs
          .map(
            (log) => `
                <tr>
                    <td>${log.id}</td>
                    <td>${log.user_id}</td>
                    <td><code>${log.endpoint || "N/A"}</code></td>
                    <td>${log.method || "N/A"}</td>
                    <td>${log.status_code || "N/A"}</td>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                </tr>
            `
          )
          .join("");
      }

      function renderNotifications(notifications) {
        const tbody = document.getElementById("notifications-tbody");
        if (notifications.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #a0a0a0;">No notifications found</td></tr>';
          return;
        }
        tbody.innerHTML = notifications
          .map(
            (notif) => `
                <tr>
                    <td>${notif.id}</td>
                    <td>${notif.title}</td>
                    <td><span class="badge badge-info">${notif.type}</span></td>
                    <td><span class="badge ${
                      notif.is_read ? "badge-success" : "badge-danger"
                    }">${notif.is_read ? "Read" : "Unread"}</span></td>
                    <td>${new Date(notif.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteNotification(${
                          notif.id
                        })">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function deleteUser(email) {
        if (!confirm(`Are you sure you want to delete user: ${email}?`)) return;

        try {
          const response = await fetch(`${API_BASE}/test/delete-user`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          const data = await response.json();

          if (data.success) {
            alert("User deleted successfully!");
            loadData();
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          alert("Failed to delete user: " + error.message);
        }
      }

      async function deleteApiKey(id) {
        if (!confirm(`Are you sure you want to delete API key ${id}?`)) return;
        // TODO: Add delete API key endpoint
        alert("Delete API key endpoint not implemented yet");
      }

      async function deleteNotification(id) {
        if (!confirm(`Are you sure you want to delete notification ${id}?`))
          return;
        // TODO: Add delete notification endpoint
        alert("Delete notification endpoint not implemented yet");
      }

      function filterTable() {
        const search = document.getElementById("search").value.toLowerCase();
        const activeTab = document.querySelector(".tab-content.active");
        const rows = activeTab.querySelectorAll("tbody tr");

        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? "" : "none";
        });
      }

      // Load data on page load
      loadData();
      // Auto-refresh every 30 seconds
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
